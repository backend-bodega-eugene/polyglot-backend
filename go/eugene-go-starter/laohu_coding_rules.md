# 老胡编程守则 v2

## 0) 工作模式切换

-   **正事模式（严谨）**：可运行、可测试、可部署，拒绝花活。
-   **玩乐模式（灵感）**：快写快验，允许样例/原型，但要明确标注
    `// prototype / WIP`。

## 1) 总原则（SIMPLE）

1.  **S**mall：函数短小，单一职责；文件不超 500 行，函数不超 80 行。
2.  **I**ntent-first：先写注释说明"为什么"，再写"怎么做"。
3.  **M**inimal deps：能用标准库就不用第三方；用三方必须说明选择原因。
4.  **P**redictable：可预期的错误路径，别吞异常；日志要可搜索。
5.  **L**east surprise：遵循各语言社区习惯（Go: idiomatic；Py: PEP8；TS:
    ESLint+Prettier）。
6.  **E**2E mindset：从调用者视角写接口，先定义 I/O 与边界条件。

## 2) 代码风格与结构

-   **命名**：业务名词统一（例如 `PlayerId`/`player_id`
    全局一致）；布尔用 `is/has/can`.
-   **目录**：按"领域/层次"而非"技术"切分（domain / app / infra /
    interfaces）。
-   **接口优先**：先定义接口/协议，再写实现；外部依赖通过接口注入。
-   **不可变优先**：尽量返回新值或拷贝，减少共享可变状态。

## 3) 错误处理 & 日志

-   **显式返回**：Go 返回 `value, err`；禁止静默失败。
-   **边界检查**：对"空、0、负数、越界、重复、超时"有明确处理。
-   **日志分级**：`DEBUG` 调试细节、`INFO` 关键路径、`WARN`
    可自愈问题、`ERROR` 需人工介入；日志含request-id/用户/关键参数摘要。
-   **不可泄密**：日志与错误信息中不可打印密钥、令牌、密码、身份证件等。

## 4) 测试红线

-   **优先级**：单测 ≥ 集成测 ≥冒烟；公共库/核心算法/钱相关逻辑必须单测。
-   **覆盖点**：正常路径 + 边界值 + 异常路径（超时/网络失败/空数据）。
-   **可测性**：I/O 抽象、时钟可注入、随机数可控；避免"时间睡眠"。
-   **基准**：关键函数提供简单 benchmark（Go: `testing.B`；）。

## 5) 性能与并发

-   **先量化**：先有指标再优化（QPS、P95、内存、GC 次数）。
-   **数据结构优先**：选对结构胜过微优化（map/set/ring buffer/池化）。
-   **并发安全**：只在需要时并发；明确所有权与生命周期；避免共享可变，必要时加锁或用消息队列。
-   **背压与超时**：所有外部调用要有
    `timeout + retry + circuit-breaker`（有上限）。

## 6) 安全与配置

-   **密钥管理**：仅走环境变量/密钥管理器；从不写进仓库。
-   **输入校验**：服务端永远校验（schema/类型/范围/正则白名单）。
-   **最小权限**：数据库账户、云资源最小权限；禁止 root 运行。
-   **配置分层**：`default → env overrides → secrets`；启动时打印配置摘要（脱敏）。

## 7) 注释与文档

-   **文件头**：写模块职责、依赖、关键决策。
-   **函数头**：`目的/参数/返回/异常/示例` 五件套。
-   **决策记录**：非显然选择写 ADR（Architecture Decision
    Record），含备选方案与取舍。
-   **变更记录**：破坏性改动在 `CHANGELOG` 标注 `BREAKING`.

## 8) Git 纪律

-   **小步提交**：每次一事，信息可读：`feat: …` `fix: …` `refactor: …`。
-   **分支策略**：`main` 只合可运行版本；新功能走 feature 分支 + PR。
-   **代码评审**：PR 模板包含背景/方案/影响面/回滚策略/测试截图。

------------------------------------------------------------------------

# 语言偏好与默认栈

## Go（后端/服务）

-   **依赖**：标准库优先；HTTP 用 `net/http` 或 `chi`；DB 用
    `sqlx`/`gorm` 有因可用；配置 `viper` 可选。
-   **并发**：`context` 全链路传递；`errgroup`
    控制并发；通道只做信号或队列，避免滥用共享 map。
-   **布局**：`/internal` 业务；`/pkg` 公共；
-   **测试**：`testing` + `gomock`/`testify`；基准对热点函数补
    `Benchmark…`.


------------------------------------------------------------------------

# 交付物标准（我给你的产出必须包含）

1.  **可运行代码** + **README**（运行/配置/测试步骤）。
2.  **样例请求/响应** 或 demo 脚本。
3.  **最少 3 个用例**（正常/边界/异常）。
4.  若涉及外部服务：提供 **本地假实现或 docker-compose**。
5.  关键处附 **取舍说明**（为什么选 A 不选 B）。

------------------------------------------------------------------------

# 模板小抄

## PR 模板（节选）

    背景：
    方案：
    影响面：接口/数据/兼容性
    测试：用例/截图/覆盖异常路径
    回滚策略：

## 函数注释模板

``` text
// doX 目的：……
// params: a=… b=…（类型/约束）
// return: (T, error) / throws FooError
// example: …
```

