<!doctype html>
<html lang="en">
<!--begin::Head-->

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>AdminLTE v4 | Dashboard</title>
    <!--begin::Accessibility Meta Tags-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#007bff" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />
    <!--end::Accessibility Meta Tags-->
    <!--begin::Primary Meta Tags-->
    <meta name="title" content="AdminLTE v4 | Dashboard" />
    <meta name="author" content="ColorlibHQ" />
    <meta name="description"
        content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS. Fully accessible with WCAG 2.1 AA compliance." />
    <meta name="keywords"
        content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard, accessible admin panel, WCAG compliant" />
    <!--end::Primary Meta Tags-->
    <!--begin::Accessibility Features-->
    <!-- Skip links will be dynamically added by accessibility.js -->
    <meta name="supported-color-schemes" content="light dark" />
    <link rel="preload" href="css/adminlte.css" as="style" />
    <!--end::Accessibility Features-->
    <!--begin::Fonts-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
        integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous" media="print"
        onload="this.media='all'" />
    <!--end::Fonts-->
    <!--begin::Third Party Plugin(OverlayScrollbars)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css"
        crossorigin="anonymous" />
    <!--end::Third Party Plugin(OverlayScrollbars)-->
    <!--begin::Third Party Plugin(Bootstrap Icons)-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
        crossorigin="anonymous" />
    <!--end::Third Party Plugin(Bootstrap Icons)-->
    <!--begin::Required Plugin(AdminLTE)-->
    <link rel="stylesheet" href="./css/adminlte.css" />
    <!--end::Required Plugin(AdminLTE)-->
    <!-- apexcharts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
        integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0=" crossorigin="anonymous" />
    <!-- jsvectormap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css"
        integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4=" crossorigin="anonymous" />

    <!-- ★ 仅用于保证侧栏里的文本和图标对齐、可见；不影响其它布局 -->
    <style>
        .app-sidebar .sidebar-menu .nav-link {
            display: flex;
            align-items: center;
        }

        .app-sidebar .sidebar-menu .nav-link p {
            margin: 0 0 0 .5rem;
            white-space: nowrap;
        }
    </style>
    <!-- ★ END -->
</head>
<!--end::Head-->
<!--begin::Body-->

<body class="layout-fixed sidebar-expand-lg sidebar-open bg-body-tertiary">
    <!--begin::App Wrapper-->
    <div class="app-wrapper">
        <!--begin::Header-->
        <nav class="app-header navbar navbar-expand bg-body">
            <!--begin::Container-->
            <div class="container-fluid">
                <!--begin::Start Navbar Links-->
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                            <i class="bi bi-list"></i>
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav ms-auto">

                    <li class="nav-item">
                        <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                            <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                            <i data-lte-icon="minimize" class="bi bi-fullscreen-exit" style="display: none"></i>
                        </a>
                    </li>
                    <!--begin::User Menu Dropdown-->
                    <li class="nav-item dropdown user-menu">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                            <img id="user-avatar" src="assets/img/eugene.jpg" class="user-image rounded-circle shadow"
                                alt="User" />
                            <span id="user-name" class="d-none d-md-inline">eugene temp</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-end">
                            <li class="user-header text-bg-primary">
                                <img id="user-avatar-large" src="assets/img/eugene.jpg" class="rounded-circle shadow"
                                    alt="User" />
                                <p id="user-title">
                                    eugene - Super Admin
                                    <small id="user-since">Member since Today</small>
                                </p>
                            </li>
                            <li class="user-footer d-flex gap-2">
                                <a id="btn-profile" href="/eugene/profile.html"
                                    class="btn btn-default btn-flat flex-fill">Profile</a>
                                <!-- <a id="btn-users" href="/eugene/users.html" class="btn btn-default btn-flat flex-fill">Users</a> -->
                                <button id="btn-signout" class="btn btn-default btn-flat flex-fill">Sign out</button>
                            </li>
                        </ul>
                    </li>
                    <!--end::User Menu Dropdown-->

                </ul>
                <!--end::End Navbar Links-->
            </div>
            <!--end::Container-->
        </nav>
        <!--end::Header-->
        <!--begin::Sidebar-->
        <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
            <!--begin::Sidebar Brand-->
            <div class="sidebar-brand">
                <!--begin::Brand Link-->
                <a href="index.html" class="brand-link">
                    <!--begin::Brand Image-->
                    <img src="assets/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image opacity-75 shadow" />
                    <!--end::Brand Image-->
                    <!--begin::Brand Text-->
                    <span class="brand-text fw-light">AdminLTE 4</span>
                    <!--end::Brand Text-->
                </a>
                <!--end::Brand Link-->
            </div>
            <!--end::Sidebar Brand-->
            <!--begin::Sidebar Wrapper-->
            <div class="sidebar-wrapper">
                <nav class="mt-2">
                    <!--begin::Sidebar Menu-->
                    <ul class="nav nav-pills nav-sidebar flex-column sidebar-menu" data-lte-toggle="treeview"
                        role="menu" aria-label="Main navigation" data-accordion="false" id="navigation">
                    </ul>
                    <!--end::Sidebar Menu-->
                </nav>
            </div>
            <!--end::Sidebar Wrapper-->
        </aside>
        <!--end::Sidebar-->
        <!--begin::App Main-->
        <main class="app-main">
            <!--begin::App Content Header-->
            <div class="app-content-header">
                <!--begin::Container-->
                <div class="container-fluid">
                    <!-- Users: Filter + Table + Pagination (no email/nickname/roles) -->
                    <div class="row g-3" id="users-page">
                        <!-- Filters -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <h3 class="card-title mb-0"><i class="bi bi-people me-2"></i>用户管理</h3>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-secondary btn-sm" id="btn-refresh">
                                            <i class="bi bi-arrow-clockwise me-1"></i>刷新
                                        </button>
                                        <button class="btn btn-primary btn-sm" id="btn-create">
                                            <i class="bi bi-plus-lg me-1"></i>新增用户
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <form id="filter-form" class="row g-2">
                                        <div class="col-12 col-sm-4">
                                            <label class="form-label">关键词</label>
                                            <input type="text" class="form-control" id="f-keyword" placeholder="用户名">
                                        </div>
                                        <div class="col-6 col-sm-3">
                                            <label class="form-label">状态</label>
                                            <select class="form-select" id="f-status">
                                                <option value="">全部</option>
                                                <option value="1">启用</option>
                                                <option value="0">禁用</option>
                                            </select>
                                        </div>
                                        <div class="col-6 col-sm-3">
                                            <label class="form-label">站点ID（可选）</label>
                                            <input type="number" class="form-control" id="f-siteId"
                                                placeholder="site_id">
                                        </div>
                                        <div class="col-6 col-sm-2">
                                            <label class="form-label">每页</label>
                                            <select class="form-select" id="f-pageSize">
                                                <option>10</option>
                                                <option>20</option>
                                                <option>50</option>
                                            </select>
                                        </div>
                                        <div class="col-12 col-sm-2 d-flex align-items-end">
                                            <button type="submit" class="btn btn-dark w-100"><i
                                                    class="bi bi-search me-1"></i>查询</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-striped mb-0 align-middle"
                                            id="users-table">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 90px;">用户ID</th>
                                                    <th style="width: 120px;">站点ID</th>
                                                    <th>用户名</th>
                                                    <th style="width: 100px;">状态</th>
                                                    <th style="width: 180px;">最近登录</th>
                                                    <th style="width: 180px;">最后更新时间</th>
                                                    <th style="width: 160px;" class="text-end pe-3">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="users-tbody">
                                                <tr>
                                                    <td colspan="7" class="text-center py-4">加载中...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div><span id="users-total">0</span> 条记录</div>
                                        <nav>
                                            <ul class="pagination pagination-sm mb-0" id="users-pager"></ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create/Edit Modal -->
                    <div class="modal fade" id="user-modal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content">
                                <form id="user-form">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="user-modal-title">新增用户</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="关闭"></button>
                                    </div>
                                    <div class="modal-body">
                                        <input type="hidden" id="u-id">
                                        <div class="row g-3">
                                            <div class="col-12 col-md-6">
                                                <label class="form-label">站点ID<span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" id="u-siteId" required>
                                            </div>
                                            <div class="col-12 col-md-6">
                                                <label class="form-label">用户名<span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="u-username" required>
                                            </div>
                                            <div class="col-12 col-md-6">
                                                <label class="form-label">状态</label>
                                                <select class="form-select" id="u-status">
                                                    <option value="1">启用</option>
                                                    <option value="0">禁用</option>
                                                </select>
                                            </div>
                                            <!-- 新增显示密码；编辑可用于“重置密码（可选）” -->
                                            <div class="col-12" id="u-password-wrap">
                                                <label class="form-label">密码（新增必填 / 编辑留空则不变）</label>
                                                <input type="password" class="form-control" id="u-password"
                                                    placeholder="后端存储为 bcrypt hash">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-secondary" type="button"
                                            data-bs-dismiss="modal">取消</button>
                                        <button class="btn btn-primary" type="submit"><i
                                                class="bi bi-check2-circle me-1"></i>保存</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                </div>
                <!--end::Container-->
            </div>
            <!--end::App Content Header-->
        </main>
        <!--end::App Main-->
        <!--begin::Footer-->
        <footer class="app-footer">
            <div class="float-end d-none d-sm-inline">Anything you want</div>
            <strong>
                Copyright &copy; 2014-2025&nbsp;
                <a href="https://adminlte.io" class="text-decoration-none">AdminLTE.io</a>.
            </strong>
            All rights reserved.
        </footer>
        <!--end::Footer-->
    </div>
    <!--end::App Wrapper-->
    <!--begin::Script-->
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"
        crossorigin="anonymous"></script>
    <script src="./js/adminlte.js"></script>

    <script>
        const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
        const Default = { scrollbarTheme: 'os-theme-light', scrollbarAutoHide: 'leave', scrollbarClickScroll: true };
        document.addEventListener('DOMContentLoaded', function () {
            const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
            if (sidebarWrapper && OverlayScrollbarsGlobal?.OverlayScrollbars !== undefined) {
                OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                    scrollbars: { theme: Default.scrollbarTheme, autoHide: Default.scrollbarAutoHide, clickScroll: Default.scrollbarClickScroll },
                });
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js" crossorigin="anonymous"></script>
    <script>
        new Sortable(document.querySelector('.connectedSortable'), { group: 'shared', handle: '.card-header' });
        const cardHeaders = document.querySelectorAll('.connectedSortable .card-header');
        cardHeaders.forEach((cardHeader) => { cardHeader.style.cursor = 'move'; });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js"
        integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>
    <script>
        const sales_chart_options = {
            series: [{ name: 'Digital Goods', data: [28, 48, 40, 19, 86, 27, 90] }, { name: 'Electronics', data: [65, 59, 80, 81, 56, 55, 40] }],
            chart: { height: 300, type: 'area', toolbar: { show: false } },
            legend: { show: false },
            colors: ['#0d6efd', '#20c997'],
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth' },
            xaxis: { type: 'datetime', categories: ['2023-01-01', '2023-02-01', '2023-03-01', '2023-04-01', '2023-05-01', '2023-06-01', '2023-07-01'] },
            tooltip: { x: { format: 'MMMM yyyy' } },
        };
        const sales_chart = new ApexCharts(document.querySelector('#revenue-chart'), sales_chart_options);
        sales_chart.render();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/js/jsvectormap.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/maps/world.js" crossorigin="anonymous"></script>
    <script>
        new jsVectorMap({ selector: '#world-map', map: 'world' });

        const option_sparkline1 = { series: [{ data: [1000, 1200, 920, 927, 931, 1027, 819, 930, 1021] }], chart: { type: 'area', height: 50, sparkline: { enabled: true } }, stroke: { curve: 'straight' }, fill: { opacity: 0.3 }, yaxis: { min: 0 }, colors: ['#DCE6EC'] };
        new ApexCharts(document.querySelector('#sparkline-1'), option_sparkline1).render();

        const option_sparkline2 = { series: [{ data: [515, 519, 520, 522, 652, 810, 370, 627, 319, 630, 921] }], chart: { type: 'area', height: 50, sparkline: { enabled: true } }, stroke: { curve: 'straight' }, fill: { opacity: 0.3 }, yaxis: { min: 0 }, colors: ['#DCE6EC'] };
        new ApexCharts(document.querySelector('#sparkline-2'), option_sparkline2).render();

        const option_sparkline3 = { series: [{ data: [15, 19, 20, 22, 33, 27, 31, 27, 19, 30, 21] }], chart: { type: 'area', height: 50, sparkline: { enabled: true } }, stroke: { curve: 'straight' }, fill: { opacity: 0.3 }, yaxis: { min: 0 }, colors: ['#DCE6EC'] };
        new ApexCharts(document.querySelector('#sparkline-3'), option_sparkline3).render();
    </script>

    <script>
        (function () {
            function getToken() { return localStorage.getItem('authToken') || sessionStorage.getItem('authToken'); }
            const token = getToken();
            if (!token) { location.href = '/eugene/login.html'; return; }

            async function fetchMenus() {
                const res = await fetch('/api/menus', { headers: { 'Authorization': 'Bearer ' + token } });
                if (res.status === 401) { location.href = '/eugene/login.html'; return []; }
                if (!res.ok) throw new Error('load menus failed');
                return res.json();
            }

            // ★ 关键：只往“侧边栏里的”#navigation 塞节点，防止同名 id 抢占
            function renderMenus(menus) {
                const root = document.querySelector('aside.app-sidebar #navigation'); // ★
                if (!root) return;
                root.innerHTML = '';

                const createItem = (node) => {
                    const hasChildren = Array.isArray(node.children) && node.children.length > 0;
                    const li = document.createElement('li');
                    li.className = 'nav-item';

                    if (!hasChildren) {
                        li.innerHTML = `
              <a href="${node.path || '#'}" class="nav-link${location.pathname === (node.path || '') ? ' active' : ''}">
                <i class="nav-icon ${node.icon || 'bi bi-speedometer'}"></i>
                <p>${node.name}</p>
              </a>`;
                        return li;
                    }

                    li.innerHTML = `
            <a href="#" class="nav-link">
              <i class="nav-icon ${node.icon || 'bi bi-folder'}"></i>
              <p>${node.name} <i class="nav-arrow bi bi-chevron-right"></i></p>
            </a>`;
                    const ul = document.createElement('ul');
                    ul.className = 'nav nav-treeview';
                    node.children.forEach(ch => ul.appendChild(createItem(ch)));
                    li.appendChild(ul);
                    return li;
                };

                menus.forEach(m => root.appendChild(createItem(m)));
            }
            // ★ END

            function jumpDefault(menus) {
                const flat = JSON.stringify(menus);
                if ((flat.includes('"/index.html"') || flat.includes('"/dashboard"')) && location.pathname === '/') {
                    location.replace('/index.html');
                }
            }

            fetchMenus()
                .then(m => { if (!m || m.length === 0) return; renderMenus(m); jumpDefault(m); })
                .catch(e => { console.error(e); location.href = '/eugene/login.html'; });
        })();
    </script>
    <script>
        (function () {
            // —— 取 token（跟你菜单那套一致）
            const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            const AUTH_HEADERS = token ? { 'Authorization': 'Bearer ' + token } : {};

            // —— DOM
            const $name = document.getElementById('user-name');
            const $title = document.getElementById('user-title');
            const $since = document.getElementById('user-since');
            const $av1 = document.getElementById('user-avatar');
            const $av2 = document.getElementById('user-avatar-large');
            const $out = document.getElementById('btn-signout');

            // —— 设置资料（角色写死：Super Admin；头像用你本地图）
            function setProfile(p = {}) {
                const n = p.nickname || p.fullName || p.realName || p.username || 'eugene';
                const sinceTxt = p.memberSince
                    ? `Member since ${new Date(p.memberSince).toLocaleDateString()}`
                    : 'Member since Today';

                if ($name) $name.textContent = n;
                if ($title) {
                    // “名字 - Super Admin”
                    $title.innerHTML = `${n} - Super Admin <small id="user-since">${sinceTxt}</small>`;
                }
                if ($since) $since.textContent = sinceTxt;

                // 头像：优先接口返回，否则用本地 eugene.jpg
                const avatar = p.avatarUrl || p.avatar || 'assets/img/eugene.jpg';
                if ($av1) $av1.src = avatar;
                if ($av2) $av2.src = avatar;
            }

            // —— 拉你自己的用户接口：优先 /api/me，退化到 /api/user/info
            async function loadProfile() {
                const endpoints = ['/api/me', '/api/user/info'];
                for (const url of endpoints) {
                    try {
                        const res = await fetch(url, { headers: AUTH_HEADERS });
                        if (!res.ok) continue;
                        const data = await res.json();
                        // 兼容 {code,data} / {data:{user}} / 直接对象
                        const u = (data && (data.data?.user || data.data)) || data || {};
                        setProfile(u);
                        return;
                    } catch (e) { /* 下一条 */ }
                }
                // 实在没有接口就填默认
                setProfile({});
            }

            // —— 退出登录
            $out?.addEventListener('click', () => {
                localStorage.removeItem('authToken');
                sessionStorage.removeItem('authToken');
                location.href = '/eugene/login.html';
            });

            loadProfile();
        })();
    </script>
    <script>
        (function () {
            // —— Auth
            const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            if (!token) { location.href = '/eugene/login.html'; return; }
            const AUTH_HEADERS = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };

            // —— State
            const state = { page: 1, pageSize: 10, total: 0, keyword: '', status: '', siteId: '', list: [] };

            // —— DOM
            const $tbody = document.getElementById('users-tbody');
            const $pager = document.getElementById('users-pager');
            const $total = document.getElementById('users-total');
            const $form = document.getElementById('filter-form');
            const $kw = document.getElementById('f-keyword');
            const $st = document.getElementById('f-status');
            const $ps = document.getElementById('f-pageSize');
            const $site = document.getElementById('f-siteId');
            const $refresh = document.getElementById('btn-refresh');
            const $create = document.getElementById('btn-create');

            // —— Modal
            const $umodal = document.getElementById('user-modal');
            const modal = new bootstrap.Modal($umodal);
            const $uform = document.getElementById('user-form');
            const $uid = document.getElementById('u-id');
            const $siteId = document.getElementById('u-siteId');
            const $uname = document.getElementById('u-username');
            const $ustatus = document.getElementById('u-status');
            const $pwdWrap = document.getElementById('u-password-wrap');
            const $pwd = document.getElementById('u-password');
            const $modalTitle = document.getElementById('user-modal-title');

            // —— Utils
            const esc = (s) => (s == null ? '' : String(s)).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
            const fmtTime = (v) => { if (!v) return '-'; const d = new Date(String(v)); return isNaN(d) ? String(v) : d.toLocaleString(); };

            // —— API
            async function apiList() {
                const params = new URLSearchParams({
                    page: state.page, pageSize: state.pageSize,
                    keyword: state.keyword || '', status: state.status || '',
                    siteId: state.siteId || ''
                });
                const res = await fetch('/api/users?' + params.toString(), { headers: AUTH_HEADERS });
                if (res.status === 401) { location.href = '/eugene/login.html'; return { list: [], total: 0 }; }
                if (!res.ok) throw new Error('加载列表失败');
                const data = await res.json();
                const payload = data?.data ?? data;
                const list = Array.isArray(payload) ? payload : (payload?.list ?? []);
                const total = Array.isArray(payload) ? payload.length : (payload?.total ?? 0);
                return { list, total };
            }
            async function apiCreate(body) {
                const res = await fetch('/api/users', { method: 'POST', headers: AUTH_HEADERS, body: JSON.stringify(body) });
                if (!res.ok) throw new Error('新增失败'); return res.json().catch(() => ({}));
            }
            async function apiUpdate(id, body) {
                const res = await fetch(`/api/users/${id}`, { method: 'PUT', headers: AUTH_HEADERS, body: JSON.stringify(body) });
                if (!res.ok) throw new Error('修改失败'); return res.json().catch(() => ({}));
            }
            async function apiDelete(id) {
                const res = await fetch(`/api/users/${id}`, { method: 'DELETE', headers: AUTH_HEADERS });
                if (!res.ok) throw new Error('删除失败'); return res.json().catch(() => ({}));
            }

            // —— Render
            function renderRows(list) {
                if (!list || list.length === 0) { $tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">暂无数据</td></tr>`; return; }
                const html = list.map(x => {
                    const id = x.user_id ?? x.userId ?? x.id ?? '';
                    const siteId = x.site_id ?? x.siteId ?? '';
                    const username = x.username ?? '';
                    const status = (x.status ?? 1) ? 1 : 0;
                    const lastLoginAt = x.last_login_at ?? x.lastLoginAt ?? '';
                    const updatedAt = x.updated_at ?? x.updatedAt ?? '';
                    return `
        <tr data-id="${esc(id)}">
          <td>${esc(id)}</td>
          <td>${esc(siteId)}</td>
          <td>${esc(username)}</td>
          <td>${status === 1 ? '<span class="badge bg-success">启用</span>' : '<span class="badge bg-secondary">禁用</span>'}</td>
          <td>${esc(fmtTime(lastLoginAt))}</td>
          <td>${esc(fmtTime(updatedAt))}</td>
          <td class="text-end pe-3">
            <button class="btn btn-outline-primary btn-sm me-1" data-op="edit"><i class="bi bi-pencil-square"></i></button>
            <button class="btn btn-outline-danger btn-sm" data-op="del"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
                }).join('');
                $tbody.innerHTML = html;
            }
            function renderPager() {
                const pages = Math.max(1, Math.ceil(state.total / state.pageSize));
                const cur = Math.min(state.page, pages);
                const li = [];
                const item = (p, txt, dis = false, act = false) =>
                    `<li class="page-item ${dis ? 'disabled' : ''} ${act ? 'active' : ''}"><a href="#" class="page-link" data-page="${p}">${txt}</a></li>`;
                li.push(item(cur - 1, '&laquo;', cur <= 1));
                const start = Math.max(1, cur - 3), end = Math.min(pages, start + 6);
                for (let p = start; p <= end; p++) li.push(item(p, p, false, p === cur));
                li.push(item(cur + 1, '&raquo;', cur >= pages));
                $pager.innerHTML = li.join('');
            }
            function renderAll() { renderRows(state.list); renderPager(); $total.textContent = state.total; }

            async function reload() {
                try {
                    $tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4">加载中...</td></tr>`;
                    const { list, total } = await apiList();
                    state.list = list; state.total = total; renderAll();
                } catch (e) { console.error(e); $tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger">加载失败</td></tr>`; }
            }

            // —— Filters
            $form.addEventListener('submit', (e) => {
                e.preventDefault();
                state.keyword = ($kw.value || '').trim();
                state.status = $st.value;
                state.siteId = ($site.value || '').trim();
                state.pageSize = parseInt($ps.value || '10', 10);
                state.page = 1; reload();
            });
            $refresh.addEventListener('click', () => reload());
            $pager.addEventListener('click', (e) => {
                const a = e.target.closest('a[data-page]'); if (!a) return; e.preventDefault();
                const p = parseInt(a.dataset.page, 10); if (Number.isNaN(p) || p === state.page) return;
                state.page = p; reload();
            });

            // —— Create
            $create.addEventListener('click', () => {
                $uform.reset(); $uid.value = ''; $modalTitle.textContent = '新增用户';
                $pwdWrap.style.display = ''; // 新增可见
                $pwd.required = true;
                modal.show();
            });

            // —— Edit/Delete
            $tbody.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-op]'); if (!btn) return;
                const tr = btn.closest('tr'); const id = tr?.dataset?.id;
                const row = state.list.find(x => String(x.user_id ?? x.userId ?? x.id) === String(id));
                if (!row) return;

                if (btn.dataset.op === 'edit') {
                    $uid.value = id;
                    $siteId.value = row.site_id ?? row.siteId ?? '';
                    $uname.value = row.username ?? '';
                    $ustatus.value = (row.status ?? 1) ? '1' : '0';
                    $pwd.value = ''; // 可选重置
                    $modalTitle.textContent = '编辑用户';
                    $pwdWrap.style.display = ''; // 允许重置密码但非必填
                    $pwd.required = false;
                    modal.show();
                }
                if (btn.dataset.op === 'del') {
                    if (!confirm('确定删除该用户？此操作不可恢复！')) return;
                    apiDelete(id).then(() => reload()).catch(e => alert(e.message || '删除失败'));
                }
            });

            // —— Save
            // —— Save（新增=POST，必须带 password；编辑=PUT，绝不传 password）
            $uform.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = $uid.value.trim();
                const isCreate = !id;

                const body = {
                    siteId: Number($siteId.value),
                    username: $uname.value.trim(),
                    status: $ustatus.value === '1' ? 1 : 0
                };

                if (isCreate) {
                    // 新增：必须带密码
                    if (!$pwd.value) {
                        alert('新增用户必须填写密码');
                        $pwd.focus();
                        return;
                    }
                    body.password = $pwd.value;
                } else {
                    // 编辑：不允许走这里改密码（保持你现有的“修改接口”纯改用户名/状态）
                    // 如果以后需要“重置密码”，单独加一个 API。
                }

                const req = isCreate ? apiCreate(body) : apiUpdate(id, body);
                req.then(() => { modal.hide(); reload(); })
                    .catch(e => alert(e.message || '保存失败'));
            });
            // —— init
            (function () { $ps.value = String(state.pageSize); })();
            reload();
        })();
    </script>

    <!--end::Script-->
</body>
<!--end::Body-->

</html>